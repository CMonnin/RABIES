# Preprocessing Pipeline

The preprocessing of fMRI scans prior to analysis consists of, at minimum, the anatomical alignment of scans to a commmon space, head realignment to correct for motion, and the correction of susceptibility distortions arising from the echo-planar imaging (EPI) acquisition of functional scans. The core preprocessing pipeline in RABIES carries each of these step with state-of-the-art processing tools and techniques. 

To conduct **common space alignment**, structural images, which were acquired along the EPI scans, are initially corrected for inhomogeneities to allow the alignment of different MRI acquisitions. This is conducted by generating an unbiased data-driven template through the iterative non-linear registration of each image to the dataset consensus average, where the average gets updated at each iteration to provide an increasingly representative dataset template (ref Gabe). The finalized template after the last iteration will provide a representative alignment of each MRI session to a template that shares the acquisition properties of the dataset (e.g. brain shape, FOV, anatomical contrast, ...), which makes it a stable target for cross-subject alignment. After aligning the MRI sessions, this newly-generated unbiased template is then itself registered to an external reference atlas to provide an anatomical segmentation and a common space more directly comparable across studies, as defined from the provided reference atlas.

The remaining preprocessing involved the EPI image. A volumetric EPI image (3D EPI average) is first derived using a trimmed mean across the EPI frames, after an initial motion realignment step (see **3D EPI generation**). Using this 3D EPI average as a target, the **head motion parameters** are estimated by realigning each EPI frame to the target using a rigid registration. To correct for the **EPI susceptibility distortions**, the 3D EPI average is first subjected to an inhomogeneity correction step, and then registered non-linearly to the anatomical scan from the same MRI session, which allows to calculate the required geometrical transforms for recovering brain anatomy (Wang et al., 2017). Finally, after calculating the transformations required to correct for head motion and susceptibility distortions, both transforms are concatenated into a single resampling operation (avoiding multiple resampling) which is applied at each EPI frame, generating the preprocessed EPI timeseries in native space (Esteban et al., 2019). Preprocessed timeseries in common space are also generated by further concatenating the transforms aligning to the reference atlas.

The workflow of the RABIES pipeline is summarized in the following diagram, and each preprocessing module is further described below:
![Processing Schema](pics/preprocessing.png)

## Structural inhomogeneity correction
## Unbiased template generation
## Atlas registration
## 3D EPI generation
## Head motion estimation
## Functional inhomogeneity correction
## Susceptibility distortion estimation
## Frame-wise resampling
### Native space
### Common space
## Adapted workflow without structural scans (i.e. --bold_only)
